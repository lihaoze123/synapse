import{a as H,b as Y}from"./useAuth-2B9FPw-q.js";import{c as Z,r as o,u as ee,f as ue,j as e,b as E,X as K,B as G,k as V,h as W}from"./index-Bm4W7kcw.js";import{h as te,c as de,i as ge,u as pe,j as me,k as fe,l as he,m as xe,t as be,f as ve,M as ye,g as je,F as Ne}from"./Layout-D9T89pnA.js";import{p as Q}from"./posts-IdGjEV-3.js";import{u as we}from"./users-DvomXxAS.js";import{u as se,D as re,b as ne,c as ae,d as oe,e as le}from"./FollowButton-CZO9unpF.js";const Ce=[["path",{d:"M16 5h6",key:"1vod17"}],["path",{d:"M19 2v6",key:"4bpg5p"}],["path",{d:"M21 11.5V19a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h7.5",key:"1ue2ih"}],["path",{d:"m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21",key:"1xmnt7"}],["circle",{cx:"9",cy:"9",r:"2",key:"af1f0g"}]],$=Z("image-plus",Ce);const ke=[["path",{d:"M21 12a9 9 0 1 1-6.219-8.56",key:"13zald"}]],X=Z("loader-circle",ke),ce=o.forwardRef(function(n,c){const{render:d,className:m,disabled:l=!1,nativeButton:b=!0,...a}=n,{store:g}=se(),h=g.useState("open");function p(r){h&&g.setOpen(!1,de(ge,r.nativeEvent))}const{getButtonProps:x,buttonRef:i}=te({disabled:l,native:b}),u=o.useMemo(()=>({disabled:l}),[l]);return ee("button",n,{state:u,ref:[c,i],props:[{onClick:p},a,x]})}),Te=o.forwardRef(function(n,c){const{render:d,className:m,disabled:l=!1,nativeButton:b=!0,id:a,payload:g,handle:h,...p}=n,x=se(!0),i=h?.store??x?.store;if(!i)throw new Error(ue(79));const u=pe(a),r=i.useState("floatingRootContext"),f=i.useState("isOpenedByTrigger",u),C=o.useRef(null),{registerTrigger:N,isMountedByThisTrigger:w}=me(u,C,i,{payload:g}),{getButtonProps:T,buttonRef:I}=te({disabled:l,native:b}),A=fe(r,{enabled:r!=null}),P=he([A]),M=o.useMemo(()=>({disabled:l,open:f}),[l,f]),R=i.useState("triggerProps",w);return ee("button",n,{state:M,ref:[I,c,N,C],props:[P.getReferenceProps(),R,{[xe]:"",id:u},p,T],stateAttributesMapping:be})});function J({mode:t="single",maxFiles:n=9,maxSize:c=5*1024*1024,value:d=[],onChange:m,disabled:l=!1,className:b,placeholder:a}){const g=o.useId(),h=o.useRef(null),[p,x]=o.useState([]),[i,u]=o.useState(!1),[r,f]=o.useState(null),C=o.useRef(new Set);o.useEffect(()=>()=>{for(const s of C.current)URL.revokeObjectURL(s);C.current.clear()},[]);const N=t==="single"?1:n,w=!l&&d.length+p.length<N,T=o.useCallback(s=>s.type.startsWith("image/")?s.size>c?`图片大小不能超过 ${Math.round(c/1024/1024)}MB`:null:"请选择图片文件",[c]),I=o.useCallback(async(s,v)=>{try{const y=await we.uploadFile(s);x(S=>S.filter(k=>k.file!==s)),C.current.delete(v),URL.revokeObjectURL(v),m?.(t==="single"?[y.url]:[...d,y.url])}catch(y){x(S=>S.map(k=>k.file===s?{...k,error:y instanceof Error?y.message:"上传失败"}:k))}},[t,d,m]),A=o.useCallback(s=>{f(null);const v=Array.from(s),y=N-d.length-p.length;if(y<=0){f(`最多只能上传 ${N} 张图片`);return}const S=v.slice(0,y);for(const k of S){const j=T(k);if(j){f(j);continue}const B=URL.createObjectURL(k);C.current.add(B);const _={file:k,preview:B,progress:0};x(ie=>[...ie,_]),I(k,B)}},[N,d.length,p.length,T,I]),P=s=>{s.target.files?.length&&A(s.target.files),s.target.value=""},M=s=>{s.preventDefault(),l||u(!0)},R=s=>{s.preventDefault(),u(!1)},D=s=>{s.preventDefault(),u(!1),!l&&s.dataTransfer.files.length&&A(s.dataTransfer.files)},O=s=>{m?.(d.filter(v=>v!==s))},q=s=>{x(v=>{const y=v.find(S=>S.file===s);return y&&(C.current.delete(y.preview),URL.revokeObjectURL(y.preview)),v.filter(S=>S.file!==s)})},L=()=>{w&&h.current?.click()},U=(s,v)=>e.jsxs("div",{className:"group relative aspect-square",children:[e.jsx("img",{src:s,alt:`已上传图片 ${v+1}`,className:"h-full w-full rounded-lg object-cover"}),!l&&e.jsx("button",{type:"button",onClick:()=>O(s),className:"absolute -right-2 -top-2 flex h-6 w-6 items-center justify-center rounded-full bg-destructive text-destructive-foreground opacity-0 shadow-md transition-opacity group-hover:opacity-100","aria-label":"删除图片",children:e.jsx(K,{className:"h-4 w-4"})})]},s),F=s=>e.jsxs("div",{className:"group relative aspect-square",children:[e.jsx("img",{src:s.preview,alt:"上传中",className:E("h-full w-full rounded-lg object-cover",!s.error&&"opacity-60")}),s.error?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"absolute inset-0 flex items-center justify-center rounded-lg bg-destructive/20",children:e.jsx("span",{className:"text-xs text-destructive",children:s.error})}),e.jsx("button",{type:"button",onClick:()=>q(s.file),className:"absolute -right-2 -top-2 flex h-6 w-6 items-center justify-center rounded-full bg-destructive text-destructive-foreground shadow-md","aria-label":"移除",children:e.jsx(K,{className:"h-4 w-4"})})]}):e.jsx("div",{className:"absolute inset-0 flex items-center justify-center",children:e.jsx(X,{className:"h-8 w-8 animate-spin text-primary"})})]},s.preview),z=()=>e.jsxs("button",{type:"button",onClick:L,onDragOver:M,onDragLeave:R,onDrop:D,disabled:!w,className:E("flex aspect-square cursor-pointer flex-col items-center justify-center gap-2 rounded-lg border-2 border-dashed transition-colors",i?"border-primary bg-primary/5":"border-muted-foreground/25 hover:border-primary/50 hover:bg-muted/50",!w&&"cursor-not-allowed opacity-50"),children:[e.jsx($,{className:"h-8 w-8 text-muted-foreground"}),e.jsx("span",{className:"text-xs text-muted-foreground",children:a||(t==="single"?"上传图片":"添加图片")})]});if(t==="single"){const s=d.length>0||p.length>0;return e.jsxs("div",{className:E("w-full",b),children:[e.jsx("input",{ref:h,id:g,type:"file",accept:"image/*",onChange:P,className:"hidden",disabled:l}),s?e.jsx("div",{className:"relative",children:p.length>0?e.jsxs("div",{className:"relative h-32 w-full",children:[e.jsx("img",{src:p[0].preview,alt:"上传中",className:"h-full w-full rounded-lg object-cover opacity-60"}),e.jsx("div",{className:"absolute inset-0 flex items-center justify-center",children:e.jsx(X,{className:"h-8 w-8 animate-spin text-primary"})})]}):e.jsxs("div",{className:"group relative h-32 w-full",children:[e.jsx("img",{src:d[0],alt:"已上传图片",className:"h-full w-full rounded-lg object-cover"}),!l&&e.jsxs("div",{className:"absolute inset-0 flex items-center justify-center gap-2 rounded-lg bg-black/50 opacity-0 transition-opacity group-hover:opacity-100",children:[e.jsx("button",{type:"button",onClick:L,className:"rounded-md bg-white/20 px-3 py-1.5 text-sm text-white hover:bg-white/30",children:"更换"}),e.jsx("button",{type:"button",onClick:()=>O(d[0]),className:"rounded-md bg-destructive/80 px-3 py-1.5 text-sm text-white hover:bg-destructive",children:"删除"})]})]})}):e.jsxs("button",{type:"button",onClick:L,onDragOver:M,onDragLeave:R,onDrop:D,disabled:l,className:E("flex h-32 w-full cursor-pointer flex-col items-center justify-center gap-2 rounded-lg border-2 border-dashed transition-colors",i?"border-primary bg-primary/5":"border-muted-foreground/25 hover:border-primary/50 hover:bg-muted/50",l&&"cursor-not-allowed opacity-50"),children:[e.jsx($,{className:"h-8 w-8 text-muted-foreground"}),e.jsx("span",{className:"text-sm text-muted-foreground",children:a||"点击或拖拽上传图片"})]}),r&&e.jsx("p",{className:"mt-2 text-sm text-destructive",children:r})]})}return e.jsxs("div",{className:E("w-full",b),children:[e.jsx("input",{ref:h,id:g,type:"file",accept:"image/*",multiple:!0,onChange:P,className:"hidden",disabled:l}),e.jsxs("div",{className:"grid grid-cols-3 gap-3",children:[d.map((s,v)=>U(s,v)),p.map(s=>F(s)),w&&z()]}),r&&e.jsx("p",{className:"mt-2 text-sm text-destructive",children:r})]})}function Se({title:t,onTitleChange:n,content:c,onContentChange:d,coverImage:m,onCoverImageChange:l,className:b}){const a=o.useRef(null),[g,h]=o.useState(!1),p=u=>{l?.(u[0]||void 0)},x=u=>{const r=a.current;if(!r)return;const f=r.selectionStart,C=r.selectionEnd,N=`![](${u})`,w=c.substring(0,f)+N+c.substring(C);d(w),setTimeout(()=>{r.focus();const T=f+N.length;r.setSelectionRange(T,T)},0)},i=u=>{u.length>0&&(x(u[0]),h(!1))};return e.jsxs("div",{className:E("space-y-3",b),children:[e.jsxs("div",{className:"space-y-1.5",children:[e.jsx("span",{className:"text-sm font-medium text-muted-foreground",children:"封面图片（可选）"}),e.jsx(J,{mode:"single",value:m?[m]:[],onChange:p,placeholder:"点击或拖拽上传封面图片"})]}),e.jsx("input",{type:"text",value:t,onChange:u=>n(u.target.value),placeholder:"文章标题",className:"w-full rounded-lg border border-input bg-background px-3 py-2 text-lg font-semibold placeholder:text-muted-foreground placeholder:font-normal focus:outline-none focus:ring-2 focus:ring-ring"}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("div",{className:"flex items-center gap-1 rounded-t-lg border border-b-0 border-input bg-muted/30 px-2 py-1",children:e.jsxs(re,{open:g,onOpenChange:h,children:[e.jsxs(Te,{className:"flex items-center gap-1 rounded px-2 py-1 text-sm text-muted-foreground hover:bg-muted hover:text-foreground transition-colors",title:"插入图片",children:[e.jsx($,{className:"h-4 w-4"}),e.jsx("span",{children:"插入图片"})]}),e.jsxs(ne,{children:[e.jsx(ae,{className:"fixed inset-0 z-50 bg-black/50"}),e.jsxs(oe,{className:"fixed left-1/2 top-1/2 z-50 w-full max-w-sm -translate-x-1/2 -translate-y-1/2 rounded-xl bg-card p-4 shadow-lg",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx(le,{className:"text-lg font-semibold",children:"插入图片"}),e.jsx(ce,{className:"rounded-lg p-1 hover:bg-muted transition-colors",children:e.jsx(K,{className:"h-5 w-5"})})]}),e.jsx(J,{mode:"single",onChange:i,placeholder:"点击或拖拽上传图片"}),e.jsx("div",{className:"mt-4 flex justify-end",children:e.jsx(G,{variant:"outline",size:"sm",onClick:()=>h(!1),children:"取消"})})]})]})]})}),e.jsx("textarea",{ref:a,value:c,onChange:u=>d(u.target.value),placeholder:"使用 Markdown 撰写文章内容...",rows:12,className:"w-full resize-none rounded-b-lg rounded-t-none border border-input bg-background px-3 py-2 text-sm placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"支持 Markdown 语法"})]})]})}function Ee({content:t,onChange:n,images:c=[],onImagesChange:d,maxLength:m=500,className:l}){return e.jsxs("div",{className:E("space-y-3",l),children:[e.jsx("textarea",{value:t,onChange:b=>n(b.target.value.slice(0,m)),placeholder:"分享你的想法...",rows:4,className:"w-full resize-none rounded-lg border border-input bg-background px-3 py-2 text-base placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring"}),e.jsx("div",{className:"flex justify-end",children:e.jsxs("span",{className:E("text-xs",t.length>m*.9?"text-destructive":"text-muted-foreground"),children:[t.length,"/",m]})}),e.jsxs("div",{className:"space-y-1.5",children:[e.jsx("span",{className:"text-sm font-medium text-muted-foreground",children:"添加图片（最多9张）"}),e.jsx(J,{mode:"multiple",maxFiles:9,value:c,onChange:d})]})]})}function Qe(t={}){return ve({queryKey:["posts",t],queryFn:({pageParam:n=0})=>Q.getPosts({...t,page:n}),getNextPageParam:n=>n.last?void 0:n.number+1,initialPageParam:0})}function ze(t){return Y({queryKey:["post",t],queryFn:()=>Q.getPost(t),enabled:t>0})}function _e(){const t=V();return H({mutationFn:n=>Q.createPost(n),onSuccess:()=>{t.invalidateQueries({queryKey:["posts"]}),t.invalidateQueries({queryKey:["tags"]})}})}function Ge(){const t=V();return H({mutationFn:({id:n,data:c})=>Q.updatePost(n,c),onSuccess:(n,c)=>{t.invalidateQueries({queryKey:["posts"]}),t.invalidateQueries({queryKey:["post",c.id]}),t.invalidateQueries({queryKey:["tags"]})}})}function $e(){const t=V();return H({mutationFn:n=>Q.deletePost(n),onSuccess:()=>{t.invalidateQueries({queryKey:["posts"]}),t.invalidateQueries({queryKey:["tags"]})}})}const Ie={async getPopularTags(t=10){const n=await W.get(`/tags?limit=${t}`);if(n.data.success&&n.data.data)return n.data.data;throw new Error(n.data.message||"Failed to fetch tags")},async getAllTags(){const t=await W.get("/tags/all");if(t.data.success&&t.data.data)return t.data.data;throw new Error(t.data.message||"Failed to fetch tags")}};function Pe(t=!0){return Y({queryKey:["tags","all"],queryFn:()=>Ie.getAllTags(),staleTime:300*1e3,enabled:t})}const Re=[{value:"javascript",label:"JavaScript"},{value:"typescript",label:"TypeScript"},{value:"java",label:"Java"},{value:"python",label:"Python"},{value:"go",label:"Go"},{value:"rust",label:"Rust"},{value:"c",label:"C"},{value:"cpp",label:"C++"},{value:"csharp",label:"C#"},{value:"php",label:"PHP"},{value:"ruby",label:"Ruby"},{value:"swift",label:"Swift"},{value:"kotlin",label:"Kotlin"},{value:"sql",label:"SQL"},{value:"html",label:"HTML"},{value:"css",label:"CSS"},{value:"json",label:"JSON"},{value:"yaml",label:"YAML"},{value:"bash",label:"Bash"},{value:"markdown",label:"Markdown"}];function Me({title:t,onTitleChange:n,code:c,onCodeChange:d,language:m,onLanguageChange:l,className:b}){return e.jsxs("div",{className:E("space-y-3",b),children:[e.jsx("input",{type:"text",value:t,onChange:a=>n(a.target.value),placeholder:"标题 (可选)",className:"w-full rounded-lg border border-input bg-background px-3 py-2 text-sm placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring"}),e.jsx("select",{value:m,onChange:a=>l(a.target.value),className:"w-full rounded-lg border border-input bg-background px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-ring",children:Re.map(({value:a,label:g})=>e.jsx("option",{value:a,children:g},a))}),e.jsx("textarea",{value:c,onChange:a=>d(a.target.value),placeholder:"粘贴你的代码...",rows:12,spellCheck:!1,className:"w-full resize-none rounded-lg border border-input bg-[#1e1e1e] px-3 py-2 font-mono text-sm text-white placeholder:text-white/40 focus:outline-none focus:ring-2 focus:ring-ring"})]})}const Le=["Java","Spring","React","TypeScript","Python","Bug","Tutorial","算法"];function Ae({tags:t,onChange:n,maxTags:c=5,suggestions:d=Le,className:m}){const[l,b]=o.useState(""),[a,g]=o.useState(!1),h=o.useRef(null),p=d.filter(r=>r.toLowerCase().includes(l.toLowerCase())&&!t.includes(r)),x=r=>{const f=r.trim().replace(/^#/,"");f&&!t.includes(f)&&t.length<c&&n([...t,f]),b(""),g(!1)},i=r=>{n(t.filter(f=>f!==r))},u=r=>{r.key==="Enter"||r.key===","?(r.preventDefault(),l&&x(l)):r.key==="Backspace"&&!l&&t.length>0&&i(t[t.length-1])};return o.useEffect(()=>{const r=f=>{h.current&&!h.current.contains(f.target)&&g(!1)};return document.addEventListener("mousedown",r),()=>document.removeEventListener("mousedown",r)},[]),e.jsxs("div",{className:E("relative",m),children:[e.jsxs("div",{className:"flex flex-wrap items-center gap-1.5 rounded-lg border border-input bg-background px-3 py-2 focus-within:ring-2 focus-within:ring-ring",children:[t.map(r=>e.jsxs("span",{className:"inline-flex items-center gap-1 rounded-md bg-secondary px-2 py-0.5 text-sm",children:["#",r,e.jsx("button",{type:"button",onClick:()=>i(r),className:"rounded hover:bg-muted",children:e.jsx(K,{className:"h-3 w-3"})})]},r)),t.length<c&&e.jsx("input",{ref:h,type:"text",value:l,onChange:r=>{b(r.target.value),g(!0)},onFocus:()=>g(!0),onKeyDown:u,placeholder:t.length===0?"添加话题...":"",className:"min-w-[80px] flex-1 bg-transparent text-sm outline-none placeholder:text-muted-foreground"})]}),a&&p.length>0&&l&&e.jsx("div",{className:"absolute top-full left-0 z-10 mt-1 w-full rounded-lg border bg-popover p-1 shadow-md",children:p.slice(0,5).map(r=>e.jsxs("button",{type:"button",onClick:()=>x(r),className:"w-full rounded px-2 py-1.5 text-left text-sm hover:bg-accent",children:["#",r]},r))}),e.jsxs("p",{className:"mt-1 text-xs text-muted-foreground",children:["最多 ",c," 个话题，按 Enter 或逗号添加"]})]})}const Oe=[{type:"MOMENT",icon:ye,label:"动态"},{type:"SNIPPET",icon:je,label:"代码"},{type:"ARTICLE",icon:Ne,label:"文章"}];function Je({open:t,onOpenChange:n,initialType:c="MOMENT",onPublish:d,isPublishing:m=!1,error:l,mode:b="create",initialData:a}){const[g,h]=o.useState(c),[p,x]=o.useState([]),i=b==="edit",u=i?"编辑内容":"发布内容",r=m?i?"保存中...":"发布中...":i?"保存":"发布";o.useEffect(()=>{t&&h(i&&a?a.type:c)},[t,c,i,a]);const{data:f}=Pe(t),C=o.useMemo(()=>f?.map(j=>j.name)??[],[f]),[N,w]=o.useState(""),[T,I]=o.useState([]),[A,P]=o.useState(""),[M,R]=o.useState(""),[D,O]=o.useState("javascript"),[q,L]=o.useState(""),[U,F]=o.useState(""),[z,s]=o.useState(void 0);o.useEffect(()=>{if(t&&i&&a)switch(x(a.tags.map(j=>j.name)),a.type){case"MOMENT":w(a.content),I(a.images||[]);break;case"SNIPPET":P(a.title||""),R(a.content),O(a.language||"javascript");break;case"ARTICLE":L(a.title||""),F(a.content),s(a.coverImage||void 0);break}else t&&!i&&(w(""),I([]),P(""),R(""),O("javascript"),L(""),F(""),s(void 0),x([]))},[t,i,a]);const v=()=>{w(""),I([]),P(""),R(""),O("javascript"),L(""),F(""),s(void 0),x([])},y=()=>{n(!1),v()},S=()=>{let j;switch(g){case"MOMENT":j={type:"MOMENT",content:N,images:T.length>0?T:void 0,tags:p};break;case"SNIPPET":j={type:"SNIPPET",title:A||void 0,content:M,language:D,tags:p};break;case"ARTICLE":j={type:"ARTICLE",title:q,content:U,coverImage:z,tags:p};break}d(j)},k=()=>{switch(g){case"MOMENT":return N.trim().length>0;case"SNIPPET":return M.trim().length>0;case"ARTICLE":return q.trim().length>0&&U.trim().length>0}};return e.jsx(re,{open:t,onOpenChange:n,children:e.jsxs(ne,{children:[e.jsx(ae,{className:"fixed inset-0 z-50 bg-black/50 data-[ending-style]:opacity-0 data-[starting-style]:opacity-0 transition-opacity"}),e.jsxs(oe,{className:"fixed left-1/2 top-1/2 z-50 w-full max-w-lg -translate-x-1/2 -translate-y-1/2 rounded-xl bg-card shadow-lg data-[ending-style]:scale-95 data-[ending-style]:opacity-0 data-[starting-style]:scale-95 data-[starting-style]:opacity-0 transition-all",children:[e.jsxs("div",{className:"flex items-center justify-between border-b border-border px-4 py-3",children:[e.jsx(le,{className:"text-lg font-semibold",children:u}),e.jsx(ce,{className:"rounded-lg p-1 hover:bg-muted transition-colors",onClick:y,children:e.jsx(K,{className:"h-5 w-5"})})]}),!i&&e.jsx("div",{className:"flex border-b border-border",children:Oe.map(({type:j,icon:B,label:_})=>e.jsxs("button",{type:"button",onClick:()=>h(j),className:E("flex flex-1 items-center justify-center gap-1.5 py-2.5 text-sm font-medium transition-colors",g===j?"border-b-2 border-primary text-primary":"text-muted-foreground hover:text-foreground"),children:[e.jsx(B,{className:"h-4 w-4"}),_]},j))}),e.jsxs("div",{className:"max-h-[60vh] overflow-y-auto p-4",children:[g==="MOMENT"&&e.jsx(Ee,{content:N,onChange:w,images:T,onImagesChange:I}),g==="SNIPPET"&&e.jsx(Me,{title:A,onTitleChange:P,code:M,onCodeChange:R,language:D,onLanguageChange:O}),g==="ARTICLE"&&e.jsx(Se,{title:q,onTitleChange:L,content:U,onContentChange:F,coverImage:z,onCoverImageChange:s}),e.jsx("div",{className:"mt-4 border-t border-border pt-4",children:e.jsx(Ae,{tags:p,onChange:x,suggestions:C})})]}),e.jsxs("div",{className:"border-t border-border px-4 py-3",children:[l&&e.jsxs("div",{className:"mb-3 p-2 text-sm text-red-600 bg-red-50 rounded-lg",children:[i?"保存失败":"发布失败","：",l]}),e.jsxs("div",{className:"flex items-center justify-end gap-2",children:[e.jsx(G,{variant:"outline",onClick:y,children:"取消"}),e.jsx(G,{onClick:S,disabled:!k()||m,children:r})]})]})]})]})})}export{Je as P,_e as a,ze as b,Ge as c,$e as d,Qe as u};
