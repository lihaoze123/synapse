import{r as i,f as B,u as I,j as r,t as Y,h as E,k as z,v as $,b as q,B as O,e as X}from"./index-Bm4W7kcw.js";import{p as V,q as L,u as _,r as j,s as Z,v as ee,w as te,x as oe,I as ne,y as se,z as ae,B as re,D as ie,b as le,c as ue,E as ce,G as de,H as pe,J as ge,K as fe,l as me,N as we,O as ye,R as he,P as Ce,Q as b,T as xe,U as ve,f as H,C as Se}from"./Layout-D9T89pnA.js";import{u as Q,b as W,a as A}from"./useAuth-2B9FPw-q.js";const G=i.createContext(void 0);function R(e){const t=i.useContext(G);if(e===!1&&t===void 0)throw new Error(B(27));return t}const be={...V,...L},Fe=i.forwardRef(function(t,o){const{render:n,className:a,forceRender:l=!1,...c}=t,{store:u}=R(),s=u.useState("open"),p=u.useState("nested"),m=u.useState("mounted"),g=u.useState("transitionStatus"),w=i.useMemo(()=>({open:s,transitionStatus:g}),[s,g]);return I("div",t,{state:w,ref:[u.context.backdropRef,o],stateAttributesMapping:be,props:[{role:"presentation",hidden:!m,style:{userSelect:"none",WebkitUserSelect:"none"}},c],enabled:l||!p})}),Pe=i.forwardRef(function(t,o){const{render:n,className:a,id:l,...c}=t,{store:u}=R(),s=_(l);return u.useSyncedValueWithCleanup("descriptionElementId",s),I("p",t,{ref:o,props:[{id:s},c]})});let Ee=(function(e){return e.nestedDialogs="--nested-dialogs",e})({}),Re=(function(e){return e[e.open=j.open]="open",e[e.closed=j.closed]="closed",e[e.startingStyle=j.startingStyle]="startingStyle",e[e.endingStyle=j.endingStyle]="endingStyle",e.nested="data-nested",e.nestedDialogOpen="data-nested-dialog-open",e})({});const J=i.createContext(void 0);function De(){const e=i.useContext(J);if(e===void 0)throw new Error(B(26));return e}const ke={...V,...L,nestedDialogOpen(e){return e?{[Re.nestedDialogOpen]:""}:null}},Oe=i.forwardRef(function(t,o){const{className:n,finalFocus:a,initialFocus:l,render:c,...u}=t,{store:s}=R(),p=s.useState("descriptionElementId"),m=s.useState("disablePointerDismissal"),g=s.useState("floatingRootContext"),w=s.useState("popupProps"),y=s.useState("modal"),d=s.useState("mounted"),f=s.useState("nested"),x=s.useState("nestedOpenDialogCount"),v=s.useState("open"),k=s.useState("openMethod"),P=s.useState("titleElementId"),F=s.useState("transitionStatus"),C=s.useState("role");De(),Z({open:v,ref:s.context.popupRef,onComplete(){v&&s.context.onOpenChangeComplete?.(!0)}});function M(S){return S==="touch"?s.context.popupRef.current:!0}const K=l===void 0?M:l,T=x>0,U=i.useMemo(()=>({open:v,nested:f,transitionStatus:F,nestedDialogOpen:T}),[v,f,F,T]),h=I("div",t,{state:U,props:[w,{"aria-labelledby":P??void 0,"aria-describedby":p??void 0,role:C,tabIndex:-1,hidden:!d,onKeyDown(S){ee.has(S.key)&&S.stopPropagation()},style:{[Ee.nestedDialogs]:x}},u],ref:[o,s.context.popupRef,s.useStateSetter("popupElement")],stateAttributesMapping:ke});return r.jsx(te,{context:g,openInteractionType:k,disabled:!d,closeOnFocusOut:!m,initialFocus:K,returnFocus:a,modal:y!==!1,restoreFocus:"popup",children:h})}),Me=i.forwardRef(function(t,o){const{keepMounted:n=!1,...a}=t,{store:l}=R(),c=l.useState("mounted"),u=l.useState("modal");return c||n?r.jsx(J.Provider,{value:n,children:r.jsxs(oe,{ref:o,...a,children:[c&&u===!0&&r.jsx(ne,{ref:l.context.internalBackdropRef,inert:se(!open)}),t.children]})}):null});function Te(e){const{store:t,parentContext:o,actionsRef:n}=e,a=t.useState("open"),l=t.useState("disablePointerDismissal"),c=t.useState("modal"),u=t.useState("popupElement"),{openMethod:s,triggerProps:p,reset:m}=ae(a);re(t);const{forceUnmount:g}=ie(a,t,()=>{m()}),w=le(h=>{const S=ue(h);return S.preventUnmountOnClose=()=>{t.set("preventUnmountingOnClose",!0)},S}),y=i.useCallback(()=>{t.setOpen(!1,w(ce))},[t,w]);i.useImperativeHandle(n,()=>({unmount:g,close:y}),[g,y]);const d=de({popupStore:t,onOpenChange:t.setOpen,treatPopupAsFloatingElement:!0,noEmit:!0}),[f,x]=i.useState(0),v=f===0,k=pe(d),P=ge(d,{outsidePressEvent(){return t.context.internalBackdropRef.current||t.context.backdropRef.current?"intentional":{mouse:c==="trap-focus"?"sloppy":"intentional",touch:"sloppy"}},outsidePress(h){if("button"in h&&h.button!==0||"touches"in h&&h.touches.length!==1)return!1;const S=we(h);if(v&&!l){const N=S;return c&&(t.context.internalBackdropRef.current||t.context.backdropRef.current)?t.context.internalBackdropRef.current===N||t.context.backdropRef.current===N||ye(N,u)&&!N?.hasAttribute("data-base-ui-portal"):!0}return!1},escapeKey:v});fe(a&&c===!0,u);const{getReferenceProps:F,getFloatingProps:C,getTriggerProps:M}=me([k,P]);t.useContextCallback("onNestedDialogOpen",h=>{x(h+1)}),t.useContextCallback("onNestedDialogClose",()=>{x(0)}),i.useEffect(()=>(o?.onNestedDialogOpen&&a&&o.onNestedDialogOpen(f),o?.onNestedDialogClose&&!a&&o.onNestedDialogClose(),()=>{o?.onNestedDialogClose&&a&&o.onNestedDialogClose()}),[a,o,f]);const K=i.useMemo(()=>F(p),[F,p]),T=i.useMemo(()=>M(p),[M,p]),U=i.useMemo(()=>C(),[C]);t.useSyncedValues({openMethod:s,activeTriggerProps:K,inactiveTriggerProps:T,popupProps:U,floatingRootContext:d,nestedOpenDialogCount:f})}const Ne={...xe,modal:b(e=>e.modal),nested:b(e=>e.nested),nestedOpenDialogCount:b(e=>e.nestedOpenDialogCount),disablePointerDismissal:b(e=>e.disablePointerDismissal),openMethod:b(e=>e.openMethod),descriptionElementId:b(e=>e.descriptionElementId),titleElementId:b(e=>e.titleElementId),viewportElement:b(e=>e.viewportElement),role:b(e=>e.role)};class je extends he{constructor(t){super(qe(t),{popupRef:i.createRef(),backdropRef:i.createRef(),internalBackdropRef:i.createRef(),triggerElements:new Ce,onOpenChange:void 0,onOpenChangeComplete:void 0},Ne)}setOpen=(t,o)=>{if(o.preventUnmountOnClose=()=>{this.set("preventUnmountingOnClose",!0)},!t&&o.trigger==null&&this.state.activeTriggerId!=null&&(o.trigger=this.state.activeTriggerElement??void 0),this.context.onOpenChange?.(t,o),o.isCanceled)return;const n={open:t,nativeEvent:o.event,reason:o.reason,nested:this.state.nested};this.state.floatingRootContext.context.events?.emit("openchange",n);const a={open:t},l=o.trigger?.id??null;(l||t)&&(a.activeTriggerId=l,a.activeTriggerElement=o.trigger??null),this.update(a)}}function qe(e={}){return{...ve(),modal:!0,disablePointerDismissal:!1,popupElement:null,viewportElement:null,descriptionElementId:void 0,titleElementId:void 0,openMethod:null,nested:!1,nestedOpenDialogCount:0,role:"dialog",...e}}function Ie(e){const{children:t,open:o,defaultOpen:n=!1,onOpenChange:a,onOpenChangeComplete:l,disablePointerDismissal:c=!1,modal:u=!0,actionsRef:s,handle:p,triggerId:m,defaultTriggerId:g=null}=e,w=R(!0),y=!!w,d=Y(()=>p?.store??new je({open:o??n,activeTriggerId:m!==void 0?m:g,modal:u,disablePointerDismissal:c,nested:y})).current;d.useControlledProp("open",o,n),d.useControlledProp("activeTriggerId",m,g),d.useSyncedValues({disablePointerDismissal:c,nested:y,modal:u}),d.useContextCallback("onOpenChange",a),d.useContextCallback("onOpenChangeComplete",l);const f=d.useState("payload");Te({store:d,actionsRef:s,parentContext:w?.store.context});const x=i.useMemo(()=>({store:d}),[d]);return r.jsx(G.Provider,{value:x,children:typeof t=="function"?t({payload:f}):t})}const Qe=i.forwardRef(function(t,o){const{render:n,className:a,id:l,...c}=t,{store:u}=R(),s=_(l);return u.useSyncedValueWithCleanup("titleElementId",s),I("h2",t,{ref:o,props:[{id:s},c]})}),D={async getFollowing(e,t=0,o=20){const n=await E.get(`/follows/following?userId=${e}&page=${t}&size=${o}`);if(n.data.success&&n.data.data)return n.data.data;throw new Error(n.data.message||"Failed to fetch following list")},async getFollowers(e,t=0,o=20){const n=await E.get(`/follows/followers?userId=${e}&page=${t}&size=${o}`);if(n.data.success&&n.data.data)return n.data.data;throw new Error(n.data.message||"Failed to fetch followers list")},async checkFollowing(e){const t=await E.get(`/follows/check/${e}`);if(t.data.success)return t.data.data;throw new Error(t.data.message||"Failed to check follow status")},async getFollowCounts(e){const t=await E.get(`/follows/counts/${e}`);if(t.data.success&&t.data.data)return t.data.data;throw new Error(t.data.message||"Failed to fetch follow counts")},async followUser(e){const t=await E.post(`/follows/${e}`);if(t.data.success&&t.data.data)return t.data.data;throw new Error(t.data.message||"Failed to follow user")},async unfollowUser(e){const t=await E.delete(`/follows/${e}`);if(!t.data.success)throw new Error(t.data.message||"Failed to unfollow user")}};function Ke(e){const{isAuthenticated:t}=Q(),{data:o,isLoading:n}=W({queryKey:["isFollowing",e],queryFn:()=>D.checkFollowing(e),enabled:t&&e>0,staleTime:120*1e3});return{isFollowing:o??!1,isLoading:n}}function We(e){return W({queryKey:["followCounts",e],queryFn:()=>D.getFollowCounts(e),enabled:e>0})}function Ae(e){return H({queryKey:["followers",e],queryFn:({pageParam:t=0})=>D.getFollowers(e,t),getNextPageParam:t=>t.last?void 0:t.number+1,initialPageParam:0,enabled:e>0})}function Ge(e){return H({queryKey:["following",e],queryFn:({pageParam:t=0})=>D.getFollowing(e,t),getNextPageParam:t=>t.last?void 0:t.number+1,initialPageParam:0,enabled:e>0})}function Ue(){const e=z(),{user:t}=Q();return A({mutationFn:o=>D.followUser(o),onMutate:async o=>{await e.cancelQueries({queryKey:["isFollowing",o]});const n=e.getQueryData(["isFollowing",o]);return e.setQueryData(["isFollowing",o],!0),{previousValue:n}},onError:(o,n,a)=>{e.setQueryData(["isFollowing",n],a?.previousValue),$.error(o.message||"关注失败，请稍后重试")},onSettled:(o,n,a)=>{e.invalidateQueries({queryKey:["isFollowing",a]}),e.invalidateQueries({queryKey:["followCounts",a]}),t?.id&&e.invalidateQueries({queryKey:["followCounts",t.id]}),e.invalidateQueries({queryKey:["followers",a]}),t?.id&&e.invalidateQueries({queryKey:["following",t.id]})}})}function Be(){const e=z(),{user:t}=Q();return A({mutationFn:o=>D.unfollowUser(o),onMutate:async o=>{await e.cancelQueries({queryKey:["isFollowing",o]});const n=e.getQueryData(["isFollowing",o]);return e.setQueryData(["isFollowing",o],!1),{previousValue:n}},onError:(o,n,a)=>{e.setQueryData(["isFollowing",n],a?.previousValue),$.error(o.message||"取消关注失败，请稍后重试")},onSettled:(o,n,a)=>{e.invalidateQueries({queryKey:["isFollowing",a]}),e.invalidateQueries({queryKey:["followCounts",a]}),t?.id&&e.invalidateQueries({queryKey:["followCounts",t.id]}),e.invalidateQueries({queryKey:["followers",a]}),t?.id&&e.invalidateQueries({queryKey:["following",t.id]})}})}function ze({className:e,...t}){return r.jsx("div",{className:q("relative flex flex-col rounded border border-gray-200 dark:border-gray-800 bg-white dark:bg-gray-950 text-gray-950 dark:text-gray-50","transition-colors duration-150","hover:border-gray-300 dark:hover:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-900",e),"data-slot":"card",...t})}function $e({open:e,onOpenChange:t,title:o,description:n,confirmLabel:a="确认",cancelLabel:l="取消",variant:c="default",onConfirm:u,isConfirming:s=!1}){const p=()=>{u()};return r.jsx(Ie,{open:e,onOpenChange:t,children:r.jsxs(Me,{children:[r.jsx(Fe,{className:"fixed inset-0 z-50 bg-black/40 data-[ending-style]:opacity-0 data-[starting-style]:opacity-0 transition-opacity"}),r.jsx(Oe,{className:"fixed left-1/2 top-1/2 z-50 w-full max-w-sm -translate-x-1/2 -translate-y-1/2 data-[ending-style]:scale-95 data-[ending-style]:opacity-0 data-[starting-style]:scale-95 data-[starting-style]:opacity-0 transition-all",children:r.jsxs(ze,{className:"p-5 shadow-md",children:[r.jsx(Qe,{className:"text-base font-medium mb-1.5",children:o}),r.jsx(Pe,{className:"text-sm text-muted-foreground mb-5",children:n}),r.jsxs("div",{className:"flex items-center justify-end gap-2",children:[r.jsx(O,{variant:"outline",size:"sm",disabled:s,onClick:()=>t(!1),children:l}),r.jsx(O,{variant:c==="destructive"?"destructive":"default",size:"sm",onClick:p,disabled:s,children:s?"处理中...":a})]})]})})]})})}function Ve(){return"ontouchstart"in window||navigator.maxTouchPoints>0}function Je({userId:e,size:t="md",className:o}){const{user:n,isAuthenticated:a}=Q(),l=X(),{isFollowing:c,isLoading:u}=Ke(e),s=Ue(),p=Be(),[m,g]=i.useState(!1),[w,y]=i.useState(!1),d=n?.id===e,f=s.isPending||p.isPending;if(d)return null;const x=C=>{if(C.preventDefault(),C.stopPropagation(),!a){l({to:"/login"});return}s.mutate(e)},v=C=>{C.preventDefault(),C.stopPropagation(),Ve()?y(!0):p.mutate(e)},k=()=>{p.mutate(e),y(!1)},P=t==="sm"?"xs":"sm",F=c&&m;return u?r.jsx(O,{size:P,variant:"outline",disabled:!0,className:q("min-w-[72px]",o),children:"..."}):c?r.jsxs(r.Fragment,{children:[r.jsx(O,{size:P,variant:F?"destructive-outline":"secondary",onClick:v,onMouseEnter:()=>g(!0),onMouseLeave:()=>g(!1),disabled:f,className:q("min-w-[72px] gap-1.5",o),children:F?"取消关注":r.jsxs(r.Fragment,{children:[r.jsx(Se,{className:"h-3.5 w-3.5"}),"已关注"]})}),r.jsx($e,{open:w,onOpenChange:y,title:"取消关注",description:"确定要取消关注此用户吗？",confirmLabel:"取消关注",variant:"destructive",onConfirm:k,isConfirming:p.isPending})]}):r.jsx(O,{size:P,variant:"default",onClick:x,disabled:f,className:q("min-w-[72px]",o),children:"关注"})}export{ze as C,Ie as D,Je as F,$e as a,Me as b,Fe as c,Oe as d,Qe as e,We as f,Ge as g,Ae as h,R as u};
