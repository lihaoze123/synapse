import{c as F,r as l,N as x,f as J,E as L,i as K,a as W,u as q,j as a,b as R,B as U,d as G,m as Q,e as X}from"./index-Bm4W7kcw.js";import{u as Z,a as C,b as A,c as ee,n as te,A as ae,d as se,e as ne,L as re,C as le}from"./Layout-D9T89pnA.js";import{u as ie}from"./users-DvomXxAS.js";import{u as oe}from"./useAuth-2B9FPw-q.js";import{u as ce}from"./useUsers-CYmB-Sqt.js";const ue=[["path",{d:"m12 19-7-7 7-7",key:"1l729n"}],["path",{d:"M19 12H5",key:"x3x0zl"}]],de=F("arrow-left",ue);const fe=[["path",{d:"M13.997 4a2 2 0 0 1 1.76 1.05l.486.9A2 2 0 0 0 18.003 7H20a2 2 0 0 1 2 2v9a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V9a2 2 0 0 1 2-2h1.997a2 2 0 0 0 1.759-1.048l.489-.904A2 2 0 0 1 10.004 4z",key:"18u6gg"}],["circle",{cx:"12",cy:"13",r:"3",key:"1vg3eu"}]],me=F("camera",fe);let T=(function(e){return e.disabled="data-disabled",e.valid="data-valid",e.invalid="data-invalid",e.touched="data-touched",e.dirty="data-dirty",e.filled="data-filled",e.focused="data-focused",e})({});const pe={badInput:!1,customError:!1,patternMismatch:!1,rangeOverflow:!1,rangeUnderflow:!1,stepMismatch:!1,tooLong:!1,tooShort:!1,typeMismatch:!1,valid:null,valueMissing:!1},ve={valid(e){return e===null?null:e?{[T.valid]:""}:{[T.invalid]:""}}},he=l.createContext({invalid:void 0,name:void 0,validityData:{state:pe,errors:[],error:"",value:"",initialValue:null},setValidityData:x,disabled:void 0,touched:!1,setTouched:x,dirty:!1,setDirty:x,filled:!1,setFilled:x,focused:!1,setFocused:x,validate:()=>null,validationMode:"onSubmit",validationDebounceTime:0,shouldValidateOnChange:()=>!1,state:{disabled:!1,valid:null,touched:!1,dirty:!1,filled:!1,focused:!1},markedDirtyRef:{current:!1},validation:{getValidationProps:(e=L)=>e,getInputValidationProps:(e=L)=>e,inputRef:{current:null},commit:async()=>{}}});function V(e=!0){const t=l.useContext(he);if(t.setValidityData===x&&!e)throw new Error(J(28));return t}const xe=l.createContext({formRef:{current:{fields:new Map}},errors:{},clearErrors:x,validationMode:"onSubmit",submitAttemptedRef:{current:!1}});function ge(){return l.useContext(xe)}const be=l.createContext({controlId:void 0,setControlId:x,labelId:void 0,setLabelId:x,messageIds:[],setMessageIds:x,getDescriptionProps:e=>e});function D(){return l.useContext(be)}function ye(e,t){return{...e,state:{...e.state,valid:!t&&e.state.valid}}}function je({controlled:e,default:t,name:s,state:i="value"}){const{current:o}=l.useRef(e!==void 0),[n,c]=l.useState(t),r=o?e:n,h=l.useCallback(p=>{o||c(p)},[]);return[r,h]}function Ne(e={}){const{id:t,implicit:s=!1,controlRef:i}=e,{controlId:o,setControlId:n}=D(),c=Z(t);return C(()=>{if(!(!s&&!t||n===x)){if(s){const r=i?.current;K(r)&&r.closest("label")!=null?n(t??null):n(o??c)}else t&&n(t);return()=>{t&&n(void 0)}}},[t,i,o,n,s,c]),o??c}function Ce(e){const{enabled:t=!0,value:s,id:i,name:o,controlRef:n,commit:c}=e,{formRef:r}=ge(),{invalid:h,markedDirtyRef:p,validityData:v,setValidityData:g}=V(),f=A(e.getValue);C(()=>{if(!t)return;let u=s;u===void 0&&(u=f()),v.initialValue===null&&u!==null&&g(y=>({...y,initialValue:u}))},[t,g,s,v.initialValue,f]),C(()=>{!t||!i||r.current.fields.set(i,{getValue:f,name:o,controlRef:n,validityData:ye(v,h),validate(){let u=s;u===void 0&&(u=f()),p.current=!0,W.flushSync(()=>c(u))}})},[c,n,t,r,f,i,h,p,o,v,s]),C(()=>{const u=r.current.fields;return()=>{i&&u.delete(i)}},[r,i])}const we=l.forwardRef(function(t,s){const{render:i,className:o,id:n,name:c,value:r,disabled:h=!1,onValueChange:p,defaultValue:v,...g}=t,{state:f,name:u,disabled:y}=V(),d=y||h,w=u??c,j=l.useMemo(()=>({...f,disabled:d}),[f,d]),{setTouched:E,setDirty:B,validityData:O,setFocused:k,setFilled:I,validationMode:_,validation:b}=V(),{labelId:z}=D(),S=Ne({id:n});C(()=>{const m=r!=null;b.inputRef.current?.value||m&&r!==""?I(!0):m&&r===""&&I(!1)},[b.inputRef,I,r]);const[P,H]=je({controlled:r,default:v,name:"FieldControl",state:"value"}),Y=r!==void 0,$=A((m,N)=>{p?.(m,N),!N.isCanceled&&H(m)});return Ce({id:S,name:w,commit:b.commit,value:P,getValue:()=>b.inputRef.current?.value,controlRef:b.inputRef}),q("input",t,{ref:s,state:j,props:[{id:S,disabled:d,name:w,ref:b.inputRef,"aria-labelledby":z,...Y?{value:P}:{defaultValue:v},onChange(m){const N=m.currentTarget.value;$(N,ee(te,m.nativeEvent)),B(N!==O.initialValue),I(N!=="")},onFocus(){k(!0)},onBlur(m){E(!0),k(!1),_==="onBlur"&&b.commit(m.currentTarget.value)},onKeyDown(m){m.currentTarget.tagName==="INPUT"&&m.key==="Enter"&&(E(!0),b.commit(m.currentTarget.value))}},b.getInputValidationProps(),g],stateAttributesMapping:ve})}),Ie=l.forwardRef(function(t,s){return a.jsx(we,{ref:s,...t})});function Re({className:e,size:t="default",unstyled:s=!1,...i}){return a.jsx("span",{className:R(!s&&"relative inline-flex w-full rounded-md border border-input bg-background text-sm transition-colors has-focus-visible:border-ring has-focus-visible:ring-1 has-focus-visible:ring-ring/50 has-aria-invalid:border-destructive has-disabled:opacity-50",e)||void 0,"data-size":t,"data-slot":"input-control",children:a.jsx(Ie,{className:R("h-9 w-full min-w-0 rounded-[inherit] px-3 outline-none placeholder:text-muted-foreground",t==="sm"&&"h-8 px-2.5 text-xs",t==="lg"&&"h-10",i.type==="search"&&"[&::-webkit-search-cancel-button]:appearance-none [&::-webkit-search-decoration]:appearance-none [&::-webkit-search-results-button]:appearance-none [&::-webkit-search-results-decoration]:appearance-none",i.type==="file"&&"text-muted-foreground file:me-3 file:bg-transparent file:font-medium file:text-foreground file:text-sm"),"data-slot":"input",size:typeof t=="number"?t:void 0,...i})})}function Ue({currentAvatarUrl:e,username:t,onUpload:s,className:i}){const[o,n]=l.useState(null),[c,r]=l.useState(!1),[h,p]=l.useState(null),v=l.useRef(null);l.useEffect(()=>()=>{o&&URL.revokeObjectURL(o)},[o]);const g=o||e,f=async y=>{const d=y.target.files?.[0];if(!d)return;if(!d.type.startsWith("image/")){p("请选择图片文件");return}if(d.size>5*1024*1024){p("图片大小不能超过 5MB");return}p(null),r(!0);const w=URL.createObjectURL(d);n(w);try{const j=await ie.uploadFile(d);s(j.url)}catch(j){p(j instanceof Error?j.message:"上传失败"),n(null)}finally{r(!1)}},u=()=>{v.current?.click()};return a.jsxs("div",{className:R("flex flex-col items-center gap-3",i),children:[a.jsxs("div",{className:"relative",children:[a.jsxs(ae,{className:"h-24 w-24 ring-4 ring-border/30",children:[a.jsx(se,{src:g||void 0,alt:t}),a.jsx(ne,{className:"text-2xl font-medium",children:t.slice(0,2).toUpperCase()})]}),c&&a.jsx("div",{className:"absolute inset-0 flex items-center justify-center rounded-full bg-black/50",children:a.jsx("div",{className:"h-6 w-6 animate-spin rounded-full border-2 border-white border-t-transparent"})})]}),a.jsx("input",{ref:v,type:"file",accept:"image/*",onChange:f,className:"hidden","aria-label":"选择头像图片"}),a.jsxs(U,{variant:"outline",size:"sm",onClick:u,disabled:c,children:[a.jsx(me,{className:"mr-1.5 h-4 w-4"}),c?"上传中...":"更换头像"]}),h&&a.jsx("p",{className:"text-sm text-destructive",children:h})]})}function M({className:e,render:t,...s}){const i={className:R("inline-flex items-center gap-2 text-base/4.5 sm:text-sm/4 font-medium",e),"data-slot":"label"};return G({defaultTagName:"label",props:Q(i,s),render:t})}function Te(){const{user:e}=oe(),t=X(),s=ce(),i=l.useId(),o=l.useRef(null),[n,c]=l.useState(e?.username??""),[r,h]=l.useState(e?.avatarUrl??""),[p,v]=l.useState(!1);if(l.useEffect(()=>()=>{o.current&&clearTimeout(o.current)},[]),!e)return null;const g=n!==e.username||r!==(e.avatarUrl??""),f=n.length>=3&&n.length<=20,u=async d=>{if(d.preventDefault(),!(!g||!f))try{await s.mutateAsync({username:n!==e.username?n:void 0,avatarUrl:r!==(e.avatarUrl??"")?r:void 0}),v(!0),o.current&&clearTimeout(o.current),o.current=setTimeout(()=>v(!1),2e3)}catch{}},y=d=>{h(d)};return a.jsx(re,{children:a.jsxs("div",{className:"max-w-lg mx-auto",children:[a.jsxs("div",{className:"flex items-center gap-3 mb-6",children:[a.jsx(U,{variant:"ghost",size:"icon",onClick:()=>t({to:"/profile"}),children:a.jsx(de,{className:"h-5 w-5"})}),a.jsx("h1",{className:"text-xl font-semibold",children:"个人资料设置"})]}),a.jsxs("form",{onSubmit:u,className:"space-y-8 bg-card rounded-xl border p-6 shadow-sm",children:[a.jsxs("div",{className:"space-y-2",children:[a.jsx(M,{children:"头像"}),a.jsx(Ue,{currentAvatarUrl:r||e.avatarUrl,username:e.username,onUpload:y,className:"py-4"})]}),a.jsxs("div",{className:"space-y-2",children:[a.jsx(M,{htmlFor:i,children:"用户名"}),a.jsx(Re,{id:i,value:n,onChange:d=>c(d.target.value),placeholder:"输入用户名",minLength:3,maxLength:20}),n.length>0&&!f&&a.jsx("p",{className:"text-sm text-destructive",children:"用户名长度需要在 3-20 个字符之间"})]}),a.jsxs("div",{className:"flex items-center gap-3",children:[a.jsx(U,{type:"submit",disabled:!g||!f||s.isPending,children:s.isPending?a.jsxs(a.Fragment,{children:[a.jsx("div",{className:"h-4 w-4 animate-spin rounded-full border-2 border-current border-t-transparent"}),"保存中..."]}):p?a.jsxs(a.Fragment,{children:[a.jsx(le,{className:"h-4 w-4"}),"已保存"]}):"保存修改"}),s.error&&a.jsx("p",{className:"text-sm text-destructive",children:s.error.message})]})]})]})})}export{Te as component};
